var Comment={};Comment.atPeople=[];Comment.atArr=[];var params={rid:0,rtype:0};Comment.init=function(newsId,rtype){params.rid=newsId;params.rtype=rtype;Comment.initPage()};Comment.initPage=function(){$("#new-com-area").empty();params.hot=0;Comment.page(1);Comment.moreComment()};Comment.face={"[/am]":{name:"傲慢",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/am.gif"},"[/ax]":{name:"爱心",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/ax.gif"},"[/bkx]":{name:"不开心",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/bkx.gif"},"[/bs]":{name:"鄙视",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/bs.gif"},"[/bx]":{name:"NO",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/bx.gif"},"[/bz]":{name:"闭嘴",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/bz.gif"},"[/ch]":{name:"擦汗",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/ch.gif"},"[/d]":{name:"呆",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/d.gif"},"[/dx]":{name:"凋谢",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/dx.gif"},"[/fh]":{name:"发火",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/fh.gif"},"[/gy]":{name:"勾引",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/gy.gif"},"[/hd]":{name:"OK",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/hd.gif"},"[/heng]":{name:"哼",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/heng.gif"},"[/hf]":{name:"互粉",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/hf.gif"},"[/huaix]":{name:"坏笑",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/huaix.gif"},"[/hx]":{name:"害羞",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/hx.gif"},"[/hxr]":{name:"火星人",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/hxr.gif"},"[/jiong]":{name:"囧",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/jiong.gif"},"[/k]":{name:"哭",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/k.gif"},"[/ka]":{name:"可爱",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/ka.gif"},"[/kbj]":{name:"看不见",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/kbj.gif"},"[/kl]":{name:"可怜",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/kl.gif"},"[/ku]":{name:"酷",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/ku.gif"},"[/lh]":{name:"流汗",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/lh.gif"},"[/mg]":{name:"玫瑰",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/mg.gif"},"[/pa]":{name:"怕",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/pa.gif"},"[/q]":{name:"强",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/q.gif"},"[/qdl]":{name:"糗大了",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/qdl.gif"},"[/qian]":{name:"钱",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/qian.gif"},"[/qiang]":{name:"枪--",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/qiang.gif"},"[/qing]":{name:"亲亲",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/qing.gif"},"[/r]":{name:"弱",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/r.gif"},"[/sl]":{name:"胜利",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/sl.gif"},"[/smm]":{name:"色迷迷",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/smm.gif"},"[/srdg]":{name:"生日蛋糕",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/srdg.gif"},"[/tp]":{name:"调皮",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/tp.gif"},"[/tx]":{name:"偷笑",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/tx.gif"},"[/wbz]":{name:"挖鼻子",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/wbz.gif"},"[/wq]":{name:"委屈",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/wq.gif"},"[/wx]":{name:"微笑",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/wx.gif"},"[/x]":{name:"吓",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/x.gif"},"[/xs]":{name:"心碎",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/xs.gif"},"[/yx]":{name:"阴险",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/yx.gif"},"[/zk]":{name:"抓狂",img:"https://img-android.d.cn/android/cdroid_stable/face/wap/zk.gif"}};Comment.replaceFace=function(comment){var reg=/\[\/.+?\]/g;comment=comment.replace(reg,function(a,b){return Comment.face[a]?"<img style='width: auto;' src='"+Comment.face[a].img+"' alt='"+Comment.face[a].name+"' title='"+Comment.face[a].name+"'/>":""});return comment};Comment.getFaceCnt=function(comment){var reg=/\[\/.+?\]/g;var n=comment.match(reg)||[];return n.length};Comment.moreComment=function(){params.hot=0;$("#clickMore").bind("click",function(){Comment.page(params.currPage+1)})};Comment.page=function(pageNo){params.pn=pageNo;$.getJSON("../comment/newComments.html",params,function(result){setTimeout(function(){Comment.bindReply()},1000);if(!result||result.TOTAL_COUNT<=0){return}var comments=result.COMMENTS;$("#commentWrap").show();$("#comNew").show();$("#comNum").html(result.TOTAL_COUNT);$("#commentCount").html(result.TOTAL_COUNT);var comNewContainer=$("#comNew .com-area");for(var i=0;i<comments.length;i++){if(!comments[i]["IP_ADDRESS"]){comments[i]["IP_ADDRESS"]="未知地区"}comments[i]["COMMENT"]=Comment.replaceFace(comments[i]["COMMENT"]);var divList=$("<div class='com-list' commentid='"+comments[i]["ID"]+"' resuser='"+comments[i]["DJID"]+"'</div>");var userNode=$("<p class='com-user'><a href='http://i.d.cn/space/"+comments[i]["DJID"]+"'><img class='user-img' src='"+changeUserImg(comments[i]["AVATAR_URL"])+"'/></a><span class='com-user-name'>"+comments[i]["TITLE"]+"</span><span class='com-user-info'>"+handlerTime(js_strto_time(comments[i]["PUBLISH_DATE"]))+"&nbsp;&nbsp;&nbsp;"+comments[i]["IP_ADDRESS"]+"</span></p>");var subNode="";var subComments=comments[i]["SUB_COMMENTS"];if(subComments&&subComments.length>0){subNode=$("<div class='com-reply-object'></div>");var show="";var length=subComments.length;for(var j=0;j<length;j++){if(length>5){if(j==1){subNode.append($("<p id='preMore' class='previous-more'>查看更多<i class='p-down'></i></p>"))}if(j!==0&&j!==subComments.length-1){show="hide"}else{show=""}}if(!subComments[j]["IP_ADDRESS"]){subComments[j]["IP_ADDRESS"]="未知地区"}var lou=j+1;subComments[j]["COMMENT"]=Comment.replaceFace(subComments[j]["COMMENT"]);var itemNode=$("<div class='"+show+" com-item' commentid='"+subComments[j]["ID"]+"'></div>");var pNode=$("<p class='com-item-user'> <span>"+subComments[j]["TITLE"]+"</span> <span class='com-item-num'>"+lou+"楼</span></p> </p>");var divNode=$("<div class='com-part'> "+subComments[j]["COMMENT"]+" </div>");var replyNode=$("<p class='com-reply-wrap'><span class='com-reply hf' data-id='"+subComments[j]["ID"]+"' data-djid='"+subComments[j]["DJID"]+"' data-user='"+subComments[j]["TITLE"]+"'><i class='iconfont'>&#xe607;</i></span></p>");itemNode.append(pNode).append(divNode).append(replyNode);subNode.append(itemNode)}subNode.append(itemNode)}var hasSupport="";var flag=Comment.getCookie("cn_d_"+comments[i]["ID"]);if(flag||flag.length>0){hasSupport="has-support"}contentNode=$("<div class='com-part'>"+comments[i]["COMMENT"]+"</div>");var backNode=$("<p class='feed-back clearfix'><span class='com-reply addSup fri' data-id='"+comments[i]["ID"]+"' data-djid='"+comments[i]["DJID"]+"' data-user='"+comments[i]["TITLE"]+"'><i class='iconfont  "+hasSupport+"'>&#xe612;</i><em class='com-feed-num'>"+comments[i]["GOOD_RAT"]+"</em><span class='add-one' style='display: none; top: -15px;position: absolute;color:#ff8b3e;'>+1</span></span><span class='com-support fri hf' data-id='"+comments[i]["ID"]+"'><em class='com-sup-num'>回复</em><i class='iconfont'>&#xe607;</i></span></p>");divList.append(userNode).append(subNode).append(contentNode).append(backNode);comNewContainer.append(divList)}if(pageNo==1){Comment.getHotComment(params)}var totalPage=result.TOTAL_PAGE;var currPage=result.CURR_PAGE;params.currPage=currPage;params.totalPage=totalPage;if(totalPage>1&&currPage+1<=totalPage){$("#clickMore").show()}else{$("#clickMore").hide()}$(".previous-more").unbind("click");Comment.show()})};Comment.addComment=function(type){var content=$("#content").val();if(content.trim()==""){alert("亲，还没有输入内容哦!");return}if(Comment.getFaceCnt(content)>10){alert("亲，最多只支持插入10个表情噢！");return}if(!DJPASS().isLogin()){window.location.href="https://oauth.d.cn/auth/goLogin.html?display=wap"}params.cmnt=content;params.replyId=$("textarea").attr("cid");params.rtype=type;Comment.atArr=[];Comment.checkAt(content,Comment.atPeople);params.atUser=Comment.atArr.join(",");$.post("/comment/addcomment.html",params,function(result){Comment.addCommentResult(params,result)})};Comment.addCommentIsCheck=function(params,captchaObj){captchaObj.appendTo(".captcha-geetest-body");captchaObj.onSuccess(function(){var res=captchaObj.getValidate();if(!res){captchaObj.reset()}params.geetest_challenge=res.geetest_challenge;params.geetest_validate=res.geetest_validate;params.geetest_seccode=res.geetest_seccode;$.post("/comment/addcomment.html",params,function(result){$("#captcha").remove();Comment.addCommentResult(params,result)})})};Comment.addCommentResult=function(params,result){if(result){switch(true){case (result.code>0||result.code==-20001):$(".com-input-wrap").hide();$(".succ").show();if($(".succ").show()){$(".succ").fadeOut(1500)}$("#headbg").show();$(".gamedeta").show();$(".footer").show();$(".fixBtn").show();Comment.atPeople=[];$("#content").val("");$(".com-cont").show();params.geetest_challenge="";params.geetest_validate="";params.geetest_seccode="";setTimeout(function(){location.reload()},500);break;case result.code==-1:alert("您已超出2000个脚印，请调整！");break;case result.code==-2:alert("您的账户已被禁言！");break;case result.code==-3:alert("评论内容中有敏感词，请检查！");break;case result.code==-4:alert("评论失败，请重试！");break;case result.code==-5:alert("您的发言太快了，喝杯茶休息一会呗！");break;case result.code==-40001:$("body").append("<div id='captcha'><div class='captcha-geetest-body'></div></div>");initGeetest({product:"bind",gt:result.data.gt,challenge:result.data.challenge,offline:!result.data.success,new_captcha:true,width:300},function(captchaObj){Comment.addCommentIsCheck(params,captchaObj)});break;default:alert(result.msg);break}}else{alert("评论失败")}};Comment.addSupport=function(supportNode){var commentId=$(supportNode).attr("data-id");var cook_key="cn_d_"+commentId;if(Comment.getCookie(cook_key)!=null&&Comment.getCookie(cook_key)!=0){supportNode.unbind("click")}else{$.get("../comment/increaseSupportCnts.html",params,function(result){if(result.messageerror){alert(result.messageerror)}else{$(supportNode).find("i").css("color","#443B3B");Comment.setCookie(cook_key,true,24*60*60);var emNode=$("em",supportNode);var cnt=parseInt(emNode.text());emNode.html(cnt+1);emNode.parent().addClass("has-support");supportNode.unbind("click");emNode.next().css("display","block").animate({top:"-50px"},{duration:500,complete:function(){$(this).css({display:"none",top:"-15px"})}})}})}};var oTop=0;Comment.bindReply=function(){$(".hf").on("click",function(){if(!DJPASS().isLogin()){toLogin()}else{$(".com-input textarea").val("");var commentId=$(this).attr("data-id");$("textarea").attr("cid",commentId);params.replyId=$("textarea").attr("cid");oTop=$(window).scrollTop();$("#headbg").hide();$(".gamedeta").hide();$(".footer").hide();$(".fixBtn").hide();$(".newsdeta").hide();$(".com-enter-wrap").hide();$(".com-wrap").hide();$(".com-input-wrap").show();$("#comInputTit").html("回复")}});$(".pl-back").on("click",function(){$(".com-input-wrap").fadeOut("fast");$("#headbg").show();$(".gamedeta").show();$(".footer").show();$(".fixBtn").show();$(".com-wrap").show();$("html,body").scrollTop(oTop)});$(".com-btn").off().on("click",function(){if(!DJPASS().isLogin()){window.location.href="https://oauth.d.cn/auth/goLogin.html?display=wap"}else{$("#headbg").hide();$(".gamedeta").hide();$(".footer").hide();$(".fixBtn").hide();$(".com-input-wrap").show();$("#comInputTit").html("发评论")}});var supports=$("span.addSup");for(var j=0;j<supports.length;j++){var support=$(supports).eq(j);support.off().on("click",function(){var commentId=$(this).attr("data-id");params.commentId=commentId;Comment.addSupport($(this))})}};Comment.show=function(){var moreNodes=$(".previous-more");for(var i=0;i<moreNodes.length;i++){var moreNode=$(moreNodes[i]);moreNode.bind("click",function(){if($(this).nextAll().hasClass("hide")){$(this).nextAll().removeClass("hide");$(this).html("收起评论")}else{$(this).nextAll().addClass("hide");$(this).parent().find(".com-item:last").removeClass("hide");$(this).html("查看更多")}})}};Comment.setCookie=function(name,value,time){var date=new Date();date.setDate(time);cookieVal=name+"="+escape(value)+((time==null)?"":";expires="+date.toGMTString());document.cookie=cookieVal};Comment.getCookie=function(name){if(document.cookie.length>0){c_start=document.cookie.indexOf(name+"=");if(c_start!=-1){c_start=c_start+name.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1){c_end=document.cookie.length}return unescape(document.cookie.substring(c_start,c_end))}}return""};Comment.inputShow=function(){scrollBack=parseInt($(window).scrollTop());$("header,.gmnews,footer,.com-enter-wrap,.newsdeta,.com-area").addClass("hide");$("div.com-input-wrap").removeClass("hide");$("#comInputTit").html("写评论");$("#comment").focus();window.scrollTo(0,0)};Comment.inputHide=function(){$("textarea").val("");$("#comSubmit").removeClass("com-submit-btn");$(".com-enter-wrap").removeClass("hide");$(".com-input-wrap").addClass("hide");$("#comment").blur();$("header,.gmnews,footer,.com-enter-wrap,.newsdeta,.com-area").removeClass("hide");window.scrollTo(0,scrollBack)};Comment.getHotComment=function(params){var toUrl="../comment/hotComments.html?rid="+params.rid+"&rtype="+params.rtype;$.ajax({url:toUrl,type:"GET",cache:false,dataType:"text",success:function(data){if(data||data!=null||data!="null"){var result=jQuery.parseJSON(data);if(result!=null&&result.length>0){$("#comHot").show();for(var i=0;i<result.length;i++){var hasSupport="";var flag=Comment.getCookie("cn_d_"+result[i]._id);if(flag||flag.length>0){hasSupport="has-support"}if(result[i].subComments==undefined){$("#hot-com-area").append('<div class="com-list" commentid="'+result[i]._id+'" resuser="'+result[i].user+'"><p class="com-user"><a href="http://i.d.cn/space/'+result[i].user+'"><img class="user-img" src="'+changeUserImg(result[i].avatarUrl)+'"/></a><span class="com-user-name">'+result[i].name+'</span><span class="com-user-info">'+handlerTime(result[i].opTime)+"&nbsp;&nbsp;&nbsp; "+result[i].ipAddress+'</span></p><div class="com-part">'+Comment.replaceFace(result[i].content)+'</div><p class="feed-back clearfix"><span class="com-reply addSup fri" data-id="'+result[i]._id+'" data-djid="'+result[i].user+'" data-user="'+result[i].name+'"><i class="iconfont '+hasSupport+'">&#xe612;</i><em class="com-feed-num">'+result[i].goodRat+'</em><span class="add-one" style="display: none; top: -15px;position: absolute;color:#ff8b3e;">+1</span></span><span class="com-support fri hf" data-id="'+result[i]._id+'"><em class="com-sup-num">回复</em><i class="iconfont">&#xe607;</i></span></p></div>')}else{var html='<div class="com-list" commentid="'+result[i]._id+'" resuser="'+result[i].user+'"><p class="com-user"><a href="http://i.d.cn/space/'+result[i].user+'"><img class="user-img" src="'+changeUserImg(result[i].avatarUrl)+'"/></a><span class="com-user-name">'+result[i].name+'</span><span class="com-user-info">'+handlerTime(result[i].opTime)+"&nbsp;&nbsp;&nbsp;"+result[i].ipAddress+'</span></p><div class="com-reply-object">';var list=result[i].subComments;for(var j=0;j<list.length;j++){var lou=j+1;html=html+'<div class="com-item" commentid="'+list[j]._id+'"><p class="com-item-user"><span>'+list[j].name+'</span><span class="com-item-num">'+lou+'楼</span></p><div class="com-part">'+Comment.replaceFace(list[j].content)+'</div><p class="com-reply-wrap"><span class="com-reply hf" data-id="'+list[j]._id+'" data-djid="'+list[j].user+'" data-user="'+list[j].name+'"><i class="iconfont">&#xe607;</i></span></p></div>'}html=html+'</div><div class="com-part">'+Comment.replaceFace(result[i].content)+'</div><p class="feed-back clearfix"><span class="com-reply addSup fri" data-id="'+result[i]._id+'" data-djid="'+result[i].user+'" data-user="'+result[i].name+'"><i class="iconfont '+hasSupport+'">&#xe612;</i><em class="com-feed-num">'+result[i].goodRat+'</em><span class="add-one" style="display: none; top: -15px;position: absolute;color:#ff8b3e;">+1</span></span><span class="com-support fri hf" data-id="'+result[i]._id+'"><em class="com-sup-num">回复</em><i class="iconfont">&#xe607;</i></span></p></div';$("#hot-com-area").append($(html))}}}else{error=1}}},error:function(){error=1}})};function handlerTime(opTime){var nowTime=new Date().getTime();var oldtime="";if(nowTime-opTime<60*60*1000){oldtime=Math.ceil((nowTime-opTime)/(60*1000))>1?Math.ceil((nowTime-opTime)/(60*1000))+"分钟  前":1+"分钟  前"}else{if(nowTime-opTime>60*60*1000&&nowTime-opTime<24*60*60*1000){oldtime=Math.ceil((nowTime-opTime)/(60*60*1000))+"小时  前"}else{if(nowTime-opTime>24*60*60*1000&&nowTime-opTime<6*24*60*60*1000){oldtime=Math.ceil((nowTime-opTime)/(24*60*60*1000))+"天  前"}else{if(nowTime-opTime>6*24*60*60*1000&&(nowTime-opTime)<28*24*60*60*1000){oldtime=Math.ceil((nowTime-opTime)/(7*24*60*60*1000))+"周  前"}else{var a=new Date(opTime);oldtime=a.getFullYear()+"年"+(a.getMonth()+1)+"月"+a.getDate()+"日"}}}}return oldtime}function js_strto_time(str_time){var timestamp=new Date(str_time.replace(/-/g,"/")).getTime();return timestamp}function changeUserImg(url){var defaultUrl="https://avatar.d.cn/userhead/get?mid=178017879&amp;size=large";if(url==""||url==null){return defaultUrl}return url}Comment.checkAt=function(val,arr){for(var i=0,j=arr.length;i<j;i+=1){if(val.indexOf(arr[i].userNick)>=0){Comment.atArr.push(arr[i].userId)}}};function toLogin(){if("undefined"!=typeof AndroidClient){AndroidClient.doLogin()()}else{location.href="https://oauth.d.cn/auth/goLogin.html?display=wap"}};